---
title: "MLE"
output:
  pdf_document: default
  html_document: default
---

```{r message=FALSE}
library(MASS)
library(pROC)
library(dplyr)
library(glmnet)
library(tibble)
library(ggplot2)
```


```{r echo=FALSE, results='hide', include=FALSE, message=FALSE}
# Data Simulation Function

data_simulation_function <- function(N, P, rho, beta_pattern) {
  Sigma <- matrix(rho, P, P)
  diag(Sigma) = 1
  
  X <- mvrnorm(n = N, mu = rep(0, P), Sigma = Sigma)
  
  # Set coefficients
  if (beta_pattern == "equal") {
    beta <- rep(0.5, P)
  } else if (beta_pattern == "strong") {
    beta <- c(1, rep(0.2, P-1))
  } else if (beta_pattern == "noise") {
    beta <- c(0, rep(0.3, P-1))
  } else if (beta_pattern == "halfnoise") {
    beta <- c(rep(0, P/2), rep(0.3, P/2))
  } else stop("Unknown beta pattern")
  
  eta <- X %*% beta
  p <- 1 / (1 + exp(-eta))
  
  y <- rbinom(N, 1, p)
  
  data.frame(y = y, X)
}

```


```{r echo=FALSE, results='hide', include=FALSE, message=FALSE}
# Model Fitting

model_fitting_function <- function(train_data) {
  glm(y ~ ., data = train_data, family = binomial)
}

```


```{r echo=FALSE, results='hide', include=FALSE, message=FALSE}
# Model Assessment function
model_assessment_function <- function(model, test_data) {
  probs <- predict(model, newdata = test_data, type = "response")
  
  auc_val <- auc(test_data$y, probs)
  brier <- mean((test_data$y - probs)^2)
  
  tibble(
    AUC = as.numeric(auc_val),
    Brier = brier
  )
}

```


```{r echo=FALSE, results='hide', include=FALSE, message=FALSE, warning=FALSE}
# Simulation Loop

set.seed(400)

EPV_vals <- c(5, 10, 50)
event_frac <- 0.5    

P_vals <- c(4, 8, 12)
rho_vals <- c(0, 0.5)
beta_patterns <- c("equal", "strong", "noise", "halfnoise")

B <- 10  

results_list <- list()
iter <- 1

for (EPV in EPV_vals) {
  for (P in P_vals) {
    for (rho in rho_vals) {
      for (bp in beta_patterns) {
        for (b in 1:B) {
          
          # Determine sample size
          N <- ceiling((EPV * P) / event_frac)
          
          # Generate full dataset
          full_data <- data_simulation_function(N, P, rho, bp)
          
          # Train-test split 70 | 30
          train_index <- sample(1:N, size = floor(0.7 * N))
          train_data <- full_data[train_index, ]
          test_data  <- full_data[-train_index, ]
          
          # Fit Model
          model <- model_fitting_function(train_data)
          
          #Assess model using test
          metrics <- model_assessment_function(model, test_data)
          
          # Add metadata
          metrics <- metrics %>%
            mutate(
              EPV = EPV,
              P = P,
              rho = rho,
              beta_pattern = bp,
              sim = b
            )
          
          results_list[[iter]] <- metrics
          iter <- iter + 1
        }
      }
    }
  }
}
results_df <- bind_rows(results_list)

# save results to csv
write.csv(results_df, "MLE_Simulation.csv", row.names = FALSE)
```

